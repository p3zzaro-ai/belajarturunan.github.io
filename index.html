<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belajar Turunan Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
      // Konfigurasi MathJax
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; background-color: #f0f4f8; }
        .page { display: none; min-height: 100vh; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .page.active { display: flex; opacity: 1; }
        .content-card, .card { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(200, 200, 200, 0.3); border-radius: 1rem; box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { animation: zoomIn 0.3s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .solution-content { display: none; border-left: 3px solid #6366f1; padding-left: 1rem; margin-top: 0.5rem; }
        
        /* Styling Kuis & Latihan Ujian & Tantangan */
        .question-panel-item { width: 2.5rem; height: 2.5rem; display: flex; justify-content: center; align-items: center; border-radius: 0.5rem; font-weight: 600; border: 2px solid #9ca3af; cursor: pointer; transition: all 0.2s; }
        .question-panel-item:hover { background-color: #e5e7eb; }
        .question-panel-item.answered { background-color: #10b981; color: white; border-color: #10b981; }
        .question-panel-item.answered-incorrect { background-color: #ef4444; color: white; border-color: #ef4444; } /* Merah untuk jawaban salah di tantangan */
        .question-panel-item.current { background-color: #6366f1; color: white; border-color: #6366f1; transform: scale(1.1); }
        .option-button:hover:not(:disabled) { background-color: #e0e7ff; }
        .option-button.selected { background-color: #6366f1; color: white; border-color: #4f46e5; }
        /* Feedback Opsi Tantangan */
        .option-button.feedback-correct { background-color: #d1fae5 !important; border-color: #34d399 !important; color: #065f46 !important; }
        .option-button.feedback-incorrect { background-color: #fee2e2 !important; border-color: #f87171 !important; color: #991b1b !important; }
        .option-button:disabled { cursor: not-allowed; opacity: 0.8; }


        /* Styling Latihan Pilihan Ganda */
        .exercise-option {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            text-align: left;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .exercise-option:not([disabled]):hover {
            border-color: #818cf8;
            background-color: #eef2ff;
        }
        .exercise-option.selected {
            border-color: #6366f1;
            background-color: #c7d2fe;
            font-weight: 600;
        }
        .exercise-option.correct {
            border-color: #34d399;
            background-color: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }
        .exercise-option.incorrect {
            border-color: #f87171;
            background-color: #fee2e2;
            color: #991b1b;
            font-weight: 600;
        }
        .exercise-option:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .clue-box {
            display: none;
            padding: 0.75rem;
            margin-top: 0.75rem;
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 0.5rem;
            color: #b45309;
            font-style: italic;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Halaman Login -->
    <div id="login-page" class="page active flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-100 to-indigo-200">
        <div class="w-full max-w-md text-center content-card p-8">
            <h1 class="text-3xl font-bold text-indigo-700 tracking-tight">Belajar Turunan Interaktif</h1>
            <p class="mt-2 text-slate-600">Media Pembelajaran & Kuis Adaptif</p>
            <div class="mt-6 space-y-4">
                <input type="text" id="student-name" placeholder="Ketik namamu di sini..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                <select id="student-class" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="">-- Pilih Kelas --</option>
                    <option value="Kelas XII-A">Kelas XII-A</option>
                    <option value="Kelas XII-B">Kelas XII-B</option>
                    <option value="Kelas XII-C">Kelas XII-C</option>
                </select>
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-2 hidden">Nama dan kelas tidak boleh kosong!</p>
            <button onclick="login()" class="mt-6 bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition w-full transform hover:scale-105">Masuk</button>
        </div>
    </div>

    <!-- Halaman Menu Utama -->
    <div id="main-menu-page" class="page flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-100 to-indigo-200">
        <div class="w-full max-w-3xl content-card p-8">
            <div id="student-info-main" class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200 flex justify-between items-center text-sm">
                <p>Nama: <span class="font-semibold" id="student-name-display-main"></span></p>
                <p>Kelas: <span class="font-semibold" id="student-class-display-main"></span></p>
            </div>
            <div class="text-center">
                <h2 class="text-3xl font-bold text-indigo-700">Materi Pembelajaran Turunan</h2>
                <p class="mt-2 text-slate-600">Pilih subbab yang ingin kamu pelajari. Selesaikan latihan di setiap subbab untuk membuka kuis!</p>
                <div id="review-buttons-container" class="mt-6 flex flex-col gap-4">
                    <!-- Tombol Review akan di-generate oleh JS -->
                </div>

                <div class="border-t pt-6 mt-8">
                    <h2 class="text-2xl font-bold text-indigo-700">Latihan & Ujian</h2>
                    <p class="mt-2 text-slate-600">Uji pemahamanmu secara menyeluruh.</p>
                    <div class="mt-6 space-y-3">
                         <button id="start-exam-button" onclick="startExamPractice(true)" class="w-full max-w-sm mx-auto bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition transform hover:scale-105 flex items-center justify-center gap-2">
                             Latihan Ujian
                         </button>
                         <button onclick="showChallengeConfirmationModal()" class="w-full max-w-sm mx-auto bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition transform hover:scale-105 mt-2">Tantangan (For Those Who Dare)</button>
                    
                         <!-- Tombol UJIAN TURUNAN (muncul jika belum) -->
                        <button id="start-final-exam-button" onclick="showFinalExamConfirmationModal()" class="w-full max-w-sm mx-auto bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition transform hover:scale-105 mt-4">
                            UJIAN TURUNAN
                        </button>
                        <!-- Tombol LIHAT HASIL (muncul jika sudah) -->
                        <button id="view-final-exam-report-button" onclick="showPage('final-exam-report-page')" class="hidden w-full max-w-sm mx-auto bg-gray-500 text-white font-semibold py-3 rounded-lg hover:bg-gray-600 transition mt-4">
                            LIHAT HASIL UJIAN
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Halaman Review Materi (Tidak ada perubahan di sini) -->
    <div id="review-page" class="page flex-col items-start justify-start bg-gradient-to-br from-slate-100 to-purple-200 p-4 sm:p-6 lg:p-8">
        <div class="w-full max-w-4xl mx-auto">
             <div class="text-center mb-4">
                 <button onclick="showPage('main-menu-page')" class="bg-white text-slate-700 font-semibold py-2 px-5 rounded-full shadow hover:bg-slate-200 transition">
                     &larr; Kembali ke Menu Utama
                 </button>
             </div>
             <div id="student-info-review" class="w-full max-w-4xl mx-auto mb-4 p-4 bg-white rounded-lg shadow-sm text-sm flex justify-between items-center">
                 <p>Nama: <span class="font-semibold" id="student-name-display-review"></span></p>
                 <p>Kelas: <span class="font-semibold" id="student-class-display-review"></span></p>
             </div>
             <header id="review-header" class="text-center mb-8"></header>
             <main id="review-content" class="space-y-10"></main>
         </div>
     </div>
    
    <!-- Halaman Kuis (Tidak ada perubahan signifikan di sini) -->
    <div id="quiz-page" class="page flex-col items-center w-full bg-slate-200">
         <div class="fixed top-0 left-0 right-0 bg-white z-50 shadow-md p-2 flex justify-between items-center">
             <div id="quiz-question-panel" class="flex flex-wrap gap-1 max-w-[calc(100%-150px)]"></div>
             <button onclick="confirmFinishQuiz()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-700 transition">Kumpulkan</button>
         </div>
         <div class="w-full max-w-5xl mx-auto mt-20 mb-24 p-4">
             <div class="card p-6">
                 <div id="student-info-quiz" class="mb-4 p-3 bg-slate-100 rounded-md border border-slate-200 text-sm flex justify-between items-center">
                     <p>Nama: <span class="font-semibold" id="student-name-display-quiz"></span></p>
                     <p>Kelas: <span class="font-semibold" id="student-class-display-quiz"></span></p>
                 </div>
                 <div class="flex justify-between items-center mb-4">
                     <span class="text-slate-600 text-sm font-semibold">Soal <span id="quiz-current-question-number">1</span> dari 10</span>
                     <span id="quiz-timer" class="text-red-500 font-bold text-lg">Waktu: 20:00</span>
                 </div>
                 <div id="quiz-question-area" class="mb-6">
                     <div class="math-text text-slate-800 mb-6 text-lg" id="quiz-question-text"></div>
                     <div id="quiz-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                 </div>
             </div>
         </div>
         <div class="fixed bottom-0 left-0 right-0 bg-white shadow-lg p-3 z-40">
             <div class="flex justify-between items-center max-w-5xl mx-auto">
                 <button id="quiz-prev-button" class="bg-indigo-600 text-white p-3 rounded-lg font-bold text-xl">&larr;</button>
                 <button id="quiz-next-button" class="bg-indigo-600 text-white p-3 rounded-lg font-bold text-xl">&rarr;</button>
             </div>
         </div>
     </div>
    
    <!-- Halaman Laporan Kuis (Tidak ada perubahan signifikan di sini) -->
     <div id="report-page" class="page flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-100 to-green-200">
         <div class="card w-full max-w-4xl p-8">
             <h1 class="text-3xl font-bold text-center mb-2 text-green-700">Laporan Hasil Kuis</h1>
             <p class="text-center text-xl font-semibold text-slate-700 mb-4" id="quiz-topic-title"></p>
             <div class="text-center mb-6 text-slate-600">
                 <p>Nama: <span id="result-name" class="font-semibold"></span></p>
                 <p>Kelas: <span id="result-class" class="font-semibold"></span></p>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                 <div class="p-6 bg-green-100 rounded-lg text-center">
                     <h2 class="text-xl font-bold text-green-800">NILAI AKHIR</h2>
                     <p id="final-score" class="text-5xl font-extrabold text-green-600 mt-2">0</p>
                 </div>
                 <div class="p-6 bg-sky-100 rounded-lg text-center">
                      <h2 class="text-xl font-bold text-sky-800">Keterangan</h2>
                     <p id="result-message" class="text-lg mt-2 text-sky-700"></p>
                 </div>
             </div>
             <div class="border-t pt-6">
                 <h2 class="text-xl font-bold text-center text-slate-700 mb-4">Rincian Jawaban</h2>
                 <div id="summary-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <!-- Rincian Jawaban Kuis di-generate JS -->
                 </div>
             </div>
              <div class="mt-8 flex flex-wrap justify-center gap-4">
                 <button onclick="showPage('main-menu-page')" class="bg-slate-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-slate-700">Ke Menu Utama</button>
                 <button id="retry-quiz-button" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700">Coba Lagi Kuis</button>
             </div>
         </div>
     </div>

    <!-- Halaman Latihan Ujian (Tidak ada perubahan signifikan di sini) -->
     <div id="exam-practice-page" class="page flex-col items-center w-full bg-slate-200">
         <div class="fixed top-0 left-0 right-0 bg-white z-50 shadow-md p-2 flex justify-between items-center">
             <div id="exam-question-panel" class="flex flex-wrap gap-1 max-w-[calc(100%-150px)]"></div>
             <button onclick="confirmFinishExamPractice()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-700 transition">Kumpulkan</button>
         </div>
         <div class="w-full max-w-5xl mx-auto mt-20 mb-24 p-4">
             <div class="card p-6">
                 <div id="student-info-exam" class="mb-4 p-3 bg-slate-100 rounded-md border border-slate-200 text-sm flex justify-between items-center">
                     <p>Nama: <span class="font-semibold" id="student-name-display-exam"></span></p>
                     <p>Kelas: <span class="font-semibold" id="student-class-display-exam"></span></p>
                 </div>
                  <h2 class="text-2xl font-bold text-indigo-700 text-center mb-4">Latihan Ujian Akhir</h2>
                 <div class="flex justify-between items-center mb-4">
                     <span class="text-slate-600 text-sm font-semibold">Soal <span id="exam-current-question-number">1</span> dari 20</span>
                     <span id="exam-timer" class="text-red-500 font-bold text-lg">Waktu: 40:00</span>
                 </div>
                 <div id="exam-question-area" class="mb-6">
                     <div class="math-text text-slate-800 mb-6 text-lg" id="exam-question-text"></div>
                     <div id="exam-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                 </div>
             </div>
         </div>
         <div class="fixed bottom-0 left-0 right-0 bg-white shadow-lg p-3 z-40">
             <div class="flex justify-between items-center max-w-5xl mx-auto">
                 <button id="exam-prev-button" class="bg-indigo-600 text-white p-3 rounded-lg font-bold text-xl">&larr;</button>
                 <button id="exam-next-button" class="bg-indigo-600 text-white p-3 rounded-lg font-bold text-xl">&rarr;</button>
             </div>
         </div>
     </div>

     <!-- Halaman Laporan Latihan Ujian (Tidak ada perubahan signifikan di sini) -->
     <div id="exam-report-page" class="page flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-100 to-green-200">
         <div class="card w-full max-w-4xl p-8">
             <h1 class="text-3xl font-bold text-center mb-2 text-green-700">Laporan Hasil Latihan Ujian</h1>
             <div class="text-center mb-6 text-slate-600">
                 <p>Nama: <span id="exam-result-name" class="font-semibold"></span></p>
                 <p>Kelas: <span id="exam-result-class" class="font-semibold"></span></p>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                 <div class="p-6 bg-green-100 rounded-lg text-center">
                     <h2 class="text-xl font-bold text-green-800">NILAI AKHIR</h2>
                     <p id="exam-final-score" class="text-5xl font-extrabold text-green-600 mt-2">0</p>
                 </div>
                 <div class="p-6 bg-sky-100 rounded-lg text-center">
                      <h2 class="text-xl font-bold text-sky-800">Keterangan</h2>
                     <p id="exam-result-message" class="text-lg mt-2 text-sky-700"></p>
                 </div>
             </div>
             <div class="border-t pt-6">
                 <h2 class="text-xl font-bold text-center text-slate-700 mb-4">Rincian Jawaban</h2>
                 <div id="exam-summary-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <!-- Rincian Jawaban Ujian di-generate JS -->
                 </div>
             </div>
              <div class="mt-8 flex flex-wrap justify-center gap-4">
                 <button onclick="showPage('main-menu-page')" class="bg-slate-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-slate-700">Ke Menu Utama</button>
                 <button onclick="startExamPractice(true)" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700">Coba Lagi Latihan Ujian</button>
             </div>
         </div>
     </div>

     <!-- Halaman Tantangan (Tidak ada perubahan signifikan di sini) -->
    <div id="challenge-page" class="page flex-col items-center w-full bg-gradient-to-br from-red-100 to-rose-200">
        <div class="fixed top-0 left-0 right-0 bg-white z-50 shadow-md p-2 flex justify-between items-center">
            <div id="challenge-question-panel" class="flex flex-wrap gap-1 max-w-[calc(100%-150px)]"></div>
            <button onclick="confirmFinishChallenge()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-700 transition">Selesaikan Tantangan</button>
        </div>
        <div class="w-full max-w-5xl mx-auto mt-20 mb-24 p-4">
            <div class="card p-6">
                <div id="student-info-challenge" class="mb-4 p-3 bg-rose-50 rounded-md border border-rose-200 text-sm flex justify-between items-center">
                    <p>Nama: <span class="font-semibold" id="student-name-display-challenge"></span></p>
                    <p>Kelas: <span class="font-semibold" id="student-class-display-challenge"></span></p>
                </div>
                 <h2 class="text-2xl font-bold text-red-700 text-center mb-4">Soal Tantangan Turunan</h2>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-slate-600 text-sm font-semibold">Soal <span id="challenge-current-question-number">1</span> dari 3</span>
                    <span id="challenge-timer" class="text-red-500 font-bold text-lg">Waktu: 30:00</span>
                </div>
                <div id="challenge-question-area" class="mb-6">
                    <div class="math-text text-slate-800 mb-6 text-lg" id="challenge-question-text"></div>
                    <div id="challenge-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                     <div class="mt-4">
                        <button id="clue-button" onclick="showClue()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-yellow-600 disabled:bg-slate-400 disabled:cursor-not-allowed">üí° Tampilkan Clue (1x)</button>
                        <div id="clue-box" class="clue-box">Clue akan muncul di sini...</div>
                    </div>
                    <div id="challenge-feedback-box" class="mt-4 text-center font-semibold"></div>
                </div>
            </div>
        </div>
        <div class="fixed bottom-0 left-0 right-0 bg-white shadow-lg p-3 z-40">
            <div class="flex justify-between items-center max-w-5xl mx-auto">
                <button id="challenge-prev-button" class="bg-red-600 text-white p-3 rounded-lg font-bold text-xl">&larr;</button>
                <button id="challenge-next-button" class="bg-red-600 text-white p-3 rounded-lg font-bold text-xl">&rarr;</button>
            </div>
        </div>
    </div>

     <!-- Halaman Laporan Tantangan (Tidak ada perubahan signifikan di sini) -->
    <div id="challenge-report-page" class="page flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-100 to-rose-200">
        <div class="card w-full max-w-4xl p-8">
            <h1 class="text-3xl font-bold text-center mb-2 text-rose-700">Laporan Hasil Tantangan</h1>
            <div class="text-center mb-6 text-slate-600">
                <p>Nama: <span id="challenge-result-name" class="font-semibold"></span></p>
                <p>Kelas: <span id="challenge-result-class" class="font-semibold"></span></p>
            </div>
             <div class="p-6 bg-rose-100 rounded-lg text-center mb-8">
                <h2 class="text-xl font-bold text-rose-800">SKOR TOTAL</h2>
                <p id="challenge-total-score" class="text-5xl font-extrabold text-rose-600 mt-2">0</p>
            </div>

            <div class="border-t pt-6">
                <h2 class="text-xl font-bold text-center text-slate-700 mb-4">Rincian Skor per Soal</h2>
                <div id="challenge-summary-container" class="space-y-4">
                    <!-- Rincian Skor Tantangan di-generate JS -->
                </div>
            </div>
             <div class="mt-8 flex flex-wrap justify-center gap-4">
                <button onclick="showPage('main-menu-page')" class="bg-slate-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-slate-700">Ke Menu Utama</button>
                <button onclick="startChallenge()" class="bg-red-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-red-700">Coba Lagi Tantangan</button>
            </div>
        </div>
    </div>

    <!-- Halaman Ujian Turunan (BARU) -->
    <div id="final-exam-page" class="page flex-col items-center w-full bg-slate-200">
        <div class="fixed top-0 left-0 right-0 bg-white z-50 shadow-md p-2 flex justify-between items-center">
            <div id="final-exam-question-panel" class="flex flex-wrap gap-1 max-w-[calc(100%-150px)]"></div>
            <button onclick="confirmFinishFinalExam()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-700 transition">Kumpulkan Ujian</button>
        </div>
        <div class="w-full max-w-5xl mx-auto mt-20 mb-24 p-4">
            <div class="card p-6">
                <div id="student-info-final-exam" class="mb-4 p-3 bg-green-50 rounded-md border border-green-200 text-sm flex justify-between items-center">
                    <p>Nama: <span class="font-semibold" id="student-name-display-final-exam"></span></p>
                    <p>Kelas: <span class="font-semibold" id="student-class-display-final-exam"></span></p>
                </div>
                 <h2 class="text-2xl font-bold text-green-700 text-center mb-4">UJIAN TURUNAN</h2>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-slate-600 text-sm font-semibold">Soal <span id="final-exam-current-question-number">1</span> dari 20</span>
                    <span id="final-exam-timer" class="text-red-500 font-bold text-lg">Waktu: 40:00</span>
                </div>
                <div id="final-exam-question-area" class="mb-6">
                    <div class="math-text text-slate-800 mb-6 text-lg" id="final-exam-question-text"></div>
                    <div id="final-exam-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
        <div class="fixed bottom-0 left-0 right-0 bg-white shadow-lg p-3 z-40">
            <div class="flex justify-between items-center max-w-5xl mx-auto">
                <button id="final-exam-prev-button" class="bg-green-600 text-white p-3 rounded-lg font-bold text-xl">&larr;</button>
                <button id="final-exam-next-button" class="bg-green-600 text-white p-3 rounded-lg font-bold text-xl">&rarr;</button>
            </div>
        </div>
    </div>

    <!-- Halaman Laporan Ujian Turunan (BARU) -->
    <div id="final-exam-report-page" class="page flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-100 to-green-200">
        <div class="card w-full max-w-4xl p-8">
            <h1 class="text-3xl font-bold text-center mb-2 text-green-700">Laporan Hasil UJIAN TURUNAN</h1>
            <div class="text-center mb-6 text-slate-600">
                <p>Nama: <span id="final-exam-result-name" class="font-semibold"></span></p>
                <p>Kelas: <span id="final-exam-result-class" class="font-semibold"></span></p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="p-6 bg-green-100 rounded-lg text-center">
                    <h2 class="text-xl font-bold text-green-800">NILAI AKHIR</h2>
                    <p id="final-exam-final-score" class="text-5xl font-extrabold text-green-600 mt-2">0</p>
                </div>
                <div class="p-6 bg-sky-100 rounded-lg text-center">
                     <h2 class="text-xl font-bold text-sky-800">Keterangan</h2>
                    <p id="final-exam-result-message" class="text-lg mt-2 text-sky-700"></p>
                </div>
            </div>
            <div class="border-t pt-6">
                <h2 class="text-xl font-bold text-center text-slate-700 mb-4">Rincian Jawaban</h2>
                <div id="final-exam-summary-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Rincian Jawaban Ujian di-generate JS -->
                </div>
            </div>
             <div class="mt-8 flex flex-wrap justify-center gap-4">
                <button onclick="showPage('main-menu-page')" class="bg-slate-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-slate-700">Ke Menu Utama</button>
                <!-- Tombol Coba Lagi Dihilangkan Sesuai Permintaan -->
             </div>
        </div>
    </div>
    
    <!-- Modal Konfirmasi -->
    <div id="confirm-submit-modal" class="modal">
         <div class="modal-content w-11/12 max-w-sm bg-white p-6 rounded-lg text-center">
            <p id="confirm-submit-message" class="mb-6 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button onclick="closeModal('confirm-submit-modal')" class="bg-slate-400 text-white px-6 py-2 rounded-lg hover:bg-slate-500">Batal</button>
                <button id="confirm-submit-yes-button" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700">Ya, Kumpulkan</button>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Paksa Latihan Ujian -->
    <div id="force-exam-modal" class="modal">
         <div class="modal-content w-11/12 max-w-sm bg-white p-6 rounded-lg text-center">
            <p class="text-yellow-600 text-4xl mb-4">‚ö†Ô∏è</p>
            <p class="mb-6 text-lg">Apakah Anda yakin ingin memulai latihan ujian secara langsung?</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeModal('force-exam-modal')" class="bg-slate-400 text-white px-6 py-2 rounded-lg hover:bg-slate-500">Batal</button>
                <button onclick="startExamPractice(true)" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Ya</button>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Tantangan -->
    <div id="confirm-challenge-modal" class="modal">
         <div class="modal-content w-11/12 max-w-md bg-white p-6 rounded-lg text-center">
            <p class="text-red-600 text-4xl mb-4">üî•</p>
            <p class="mb-6 text-lg">Ini adalah soal tantangan yang berisi soal analisis sulit berkaitan tentang Turunan, apakah Anda yakin ingin mengerjakan?</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeModal('confirm-challenge-modal')" class="bg-slate-400 text-white px-6 py-2 rounded-lg hover:bg-slate-500">Tidak</button>
                <button onclick="startChallenge()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Yakin</button>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi UJIAN TURUNAN (BARU) -->
    <div id="confirm-final-exam-modal" class="modal">
         <div class="modal-content w-11/12 max-w-md bg-white p-6 rounded-lg text-center">
            <p class="text-green-600 text-4xl mb-4">üèÜ</p>
            <p class="mb-6 text-lg">Yakin ingin memulai ujian? Anda hanya bisa mengerjakan ujian ini satu kali.</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeModal('confirm-final-exam-modal')" class="bg-slate-400 text-white px-6 py-2 rounded-lg hover:bg-slate-500">Ntar dulu :(</button>
                <button onclick="startFinalExam()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Yakin dongz :)</button>
            </div>
        </div>
    </div>


<script>
// --- KONFIGURASI DAN DATA ---
const APP_STATE_KEY = 'derivativeAppState';

// Data untuk halaman review (Termasuk data jawaban latihan)
const reviewData = {
    konsepDasar: {
        id: 'konsepDasar',
        title: 'Konsep Dasar & Definisi',
        sections: [
            {
                title: "Definisi Turunan Menggunakan Limit",
                content: "Turunan adalah laju perubahan sesaat, yang secara matematis didefinisikan sebagai limit. Rumus ini adalah fondasi dari semua aturan turunan yang akan kita pelajari.",
                example: {
                    problem: "Cari turunan dari $f(x) = 3x^2$ menggunakan definisi limit: $f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$",
                    solution: [
                        "$f(x+h) = 3(x+h)^2 = 3(x^2+2xh+h^2) = 3x^2+6xh+3h^2$.",
                        "$f'(x) = \\lim_{h \\to 0} \\frac{(3x^2+6xh+3h^2) - 3x^2}{h}$",
                        "$f'(x) = \\lim_{h \\to 0} \\frac{6xh+3h^2}{h} = \\lim_{h \\to 0} \\frac{h(6x+3h)}{h}$",
                        "Coret $h$: $\\lim_{h \\to 0} (6x+3h)$.",
                        "Substitusi $h=0$: $6x + 3(0) = 6x$."
                    ]
                },
                exercises: [
                    { id: 'kd-1', problem: "Turunan dari fungsi konstan $f(x) = 10$ adalah...", choices: ["10", "1", "0", "x", "-10"], answer: '0', explanation: "Fungsi konstan tidak memiliki perubahan, sehingga laju perubahannya (turunannya) adalah 0." },
                    { id: 'kd-2', problem: "Turunan dari $f(x)=5x$ adalah...", choices: ["5x", "x", "5", "0", "1"], answer: '5', explanation: "Menggunakan definisi limit, $\\lim_{h \\to 0} \\frac{5(x+h) - 5x}{h} = \\lim_{h \\to 0} \\frac{5h}{h} = 5$." },
                ]
            }
        ]
    },
    aturanDasar: {
        id: 'aturanDasar',
        title: 'Aturan Dasar Turunan Aljabar',
        sections: [
            {
                title: "Aturan Pangkat (Power Rule)",
                content: "Ini adalah aturan paling fundamental. Jika $f(x) = ax^n$, maka turunannya adalah $f'(x) = a \\cdot n \\cdot x^{n-1}$. Pangkatnya turun ke depan, lalu pangkatnya dikurangi satu.",
                example: {
                    problem: "Turunan dari $f(x) = 2x^3 - 6x^2 + 5$",
                    solution: [
                        "Kita turunkan suku demi suku menggunakan Aturan Pangkat.",
                        "Turunan dari $2x^3$ adalah $2 \\cdot 3 \\cdot x^{3-1} = 6x^2$.",
                        "Turunan dari $-6x^2$ adalah $-6 \\cdot 2 \\cdot x^{2-1} = -12x$.",
                        "Turunan dari konstanta $5$ adalah $0$.",
                        "Gabungkan hasilnya: $f'(x) = 6x^2 - 12x$."
                    ]
                },
                exercises: [
                    { id: 'ad-1', problem: "Turunan dari $f(x) = 7x^3$ adalah...", choices: ["$7x^2$", "$21x^3$", "$21x^2$", "$3x^2$", "$7x$"], answer: '$21x^2$', explanation: "Gunakan aturan pangkat: $f'(x) = 7 \\cdot 3 \\cdot x^{3-1} = 21x^2$." },
                    { id: 'ad-2', problem: "Turunan dari $g(x) = -2x^{-4}$ adalah...", choices: ["$-8x^{-5}$", "$8x^{-3}$", "$8x^{-5}$", "$-6x^{-3}$", "$-8x^{-3}$"], answer: '$8x^{-5}$', explanation: "$g'(x) = -2 \\cdot (-4) \\cdot x^{-4-1} = 8x^{-5}$." }
                ]
            },
            {
                title: "Aturan Perkalian & Pembagian",
                content: "Untuk fungsi yang dikalikan, $h(x) = uv$, maka $h'(x) = u'v + uv'$. Untuk pembagian, $h(x) = \\frac{u}{v}$, maka $h'(x) = \\frac{u'v - uv'}{v^2}$.",
                example: {
                    problem: "Cari turunan dari $f(x) = \\frac{2x+1}{x-3}$",
                    solution: [
                        "Misal $u=2x+1 \\Rightarrow u'=2$.",
                        "Misal $v=x-3 \\Rightarrow v'=1$.",
                        "Gunakan rumus pembagian: $f'(x) = \\frac{u'v - uv'}{v^2}$.",
                        "$f'(x) = \\frac{(2)(x-3) - (2x+1)(1)}{(x-3)^2} = \\frac{2x-6-2x-1}{(x-3)^2}$.",
                        "Hasilnya: $f'(x) = \\frac{-7}{(x-3)^2}$."
                    ]
                },
                exercises: [
                     { id: 'ad-3', problem: "Turunan dari $f(x) = (x^2)(3x+1)$ menggunakan aturan perkalian adalah...", choices: ["$6x$", "$3x^2+1$", "$9x^2+2x$", "$6x+1$", "$6x^2+1$"], answer: '$9x^2+2x$', explanation: "Misal $u=x^2, v=3x+1$. Maka $u'=2x, v'=3$. $f'(x) = u'v+uv' = (2x)(3x+1) + (x^2)(3) = 6x^2+2x+3x^2 = 9x^2+2x$." },
                     { id: 'ad-4', problem: "Turunan dari $f(x) = \\frac{x+1}{x-1}$ adalah...", choices: ["1", "$\\frac{2}{(x-1)^2}$", "$\\frac{-2}{(x-1)^2}$", "$\\frac{2x}{(x-1)^2}$", "-2"], answer: '$\\frac{-2}{(x-1)^2}$', explanation: "Misal $u=x+1, v=x-1$. Maka $u'=1, v'=1$. $f'(x) = \\frac{u'v-uv'}{v^2} = \\frac{(1)(x-1) - (x+1)(1)}{(x-1)^2} = \\frac{x-1-x-1}{(x-1)^2} = \\frac{-2}{(x-1)^2}$." }
                ]
            }
        ]
    },
    trigoRantai: {
        id: 'trigoRantai',
        title: 'Trigonometri & Aturan Rantai',
        sections: [
            {
                title: "Aturan Rantai (Chain Rule)",
                content: "Digunakan untuk fungsi komposisi atau 'fungsi di dalam fungsi'. Caranya: turunkan fungsi luar (isi dalamnya tetap), lalu kalikan dengan turunan fungsi dalamnya. Jika $y = f(g(x))$, maka $y' = f'(g(x)) \\cdot g'(x)$",
                example: {
                    problem: "Tentukan turunan dari $y = (5x^3 - 2)^4$.",
                    solution: [
                        "Fungsi luar adalah $(\\dots)^4$, turunannya $4(\\dots)^3$.",
                        "Fungsi dalam adalah $5x^3 - 2$, turunannya $15x^2$.",
                        "Gabungkan: $y' = 4(5x^3 - 2)^3 \\cdot (15x^2)$.",
                        "Hasil: $y' = 60x^2(5x^3 - 2)^3$."
                    ]
                },
                exercises: [
                    { id: 'tr-1', problem: "Turunan dari $y = (2x+5)^3$ adalah...", choices: ["$3(2x+5)^2$", "$2(2x+5)^2$", "$6(2x+5)^2$", "$3(2x+5)^3$", "$6(2x+5)^3$"], answer: '$6(2x+5)^2$', explanation: "Turunan luar: $3(\\dots)^2$. Turunan dalam: $2$. Hasilnya: $3(2x+5)^2 \\cdot 2 = 6(2x+5)^2$." }
                ]
            },
            {
                title: "Turunan Fungsi Trigonometri",
                content: "Dasar: $(\\sin x)' = \\cos x$ dan $(\\cos x)' = -\\sin x$. Jika digabung dengan aturan rantai, misal $y = \\sin(u)$, maka $y' = \\cos(u) \\cdot u' $.",
                example: {
                    problem: "Turunan dari $f(x) = \\cos(4x^2 - x)$",
                    solution: [
                        "Fungsi luar adalah $\\cos(u)$, turunannya $-\\sin(u)$.",
                        "Fungsi dalam $u=4x^2-x$, turunannya $u'=8x-1$.",
                        "Gabungkan: $f'(x) = -\\sin(4x^2-x) \\cdot (8x-1)$.",
                        "Hasil: $f'(x) = -(8x-1)\\sin(4x^2-x)$."
                    ]
                },
                exercises: [
                    { id: 'tr-2', problem: "Turunan dari $y=\\sin(5x)$ adalah...", choices: ["$\\cos(5x)$", "$-5\\cos(5x)$", "$5\\cos(5x)$", "$-\\cos(5x)$", "$5\\sin(5x)$"], answer: '$5\\cos(5x)$', explanation: "Turunan dari $\\sin(u)$ adalah $\\cos(u) \\cdot u'$. Disini $u=5x$ dan $u'=5$. Maka hasilnya $5\\cos(5x)$." },
                    { id: 'tr-3', problem: "Turunan dari $y=\\tan(x)$ adalah...", choices: ["$\\cot(x)$", "$\\sec(x)\\tan(x)$", "$\\sec^2(x)$", "$-\\csc^2(x)$", "1"], answer: '$\\sec^2(x)$', explanation: "$y=\\frac{\\sin x}{\\cos x}$. Gunakan aturan pembagian: $\\frac{(\\cos x)(\\cos x) - (\\sin x)(-\\sin x)}{\\cos^2 x} = \\frac{\\cos^2 x + \\sin^2 x}{\\cos^2 x} = \\frac{1}{\\cos^2 x} = \\sec^2 x$." }
                ]
            }
        ]
    },
    aplikasi1: {
        id: 'aplikasi1',
        title: 'Aplikasi Turunan Pertama',
        sections: [
            {
                title: "Gradien dan Persamaan Garis Singgung",
                content: "Nilai turunan pertama di suatu titik, $f'(a)$, adalah gradien (kemiringan) garis singgung kurva $y=f(x)$ di titik $x=a$. Persamaan garisnya adalah $y-y_1 = m(x-x_1)$.",
                example: {
                    problem: "Tentukan persamaan garis singgung kurva $f(x)=x^2-3x+4$ di titik $(1, 2)$.",
                    solution: [
                        "Cari gradien, $m = f'(x) = 2x-3$.",
                        "Substitusi absis $x=1$: $m = f'(1) = 2(1)-3 = -1$.",
                        "Gunakan rumus dengan titik $(1, 2)$ dan $m=-1$: $y - 2 = -1(x - 1)$.",
                        "$y - 2 = -x + 1 \\Rightarrow y = -x + 3$."
                    ]
                },
                exercises: [
                    { id: 'ap1-1', problem: "Gradien garis singgung kurva $y=x^3-6x$ di $x=2$ adalah...", choices: ["12", "0", "8", "6", "-2"], answer: '6', explanation: "$y'=3x^2-6$. Substitusi $x=2$ menjadi $m = 3(2)^2 - 6 = 12-6=6$." }
                ]
            },
            {
                title: "Fungsi Naik, Turun, dan Titik Stasioner",
                content: "Grafik fungsi $f(x)$ akan NAIK jika $f'(x) > 0$, dan TURUN jika $f'(x) < 0$. Titik stasioner (puncak/lembah) terjadi saat gradien nol, yaitu $f'(x) = 0$.",
                example: {
                    problem: "Tentukan interval naik dari fungsi $f(x) = x^3 - 12x$.",
                    solution: [
                        "Cari turunan: $f'(x) = 3x^2 - 12$.",
                        "Cari titik stasioner ($f'(x)=0$): $3x^2-12=0 \\Rightarrow x^2=4 \\Rightarrow x=-2$ dan $x=2$.",
                        "Buat garis bilangan dengan batas -2 dan 2. Uji titik di setiap interval pada $f'(x)$:",
                        "Untuk $x<-2$ (misal $x=-3$), $f'(-3) = 3(9)-12 = 15$ (positif, NAIK).",
                        "Untuk $-2<x<2$ (misal $x=0$), $f'(0)=-12$ (negatif, TURUN).",
                        "Untuk $x>2$ (misal $x=3$), $f'(3)=15$ (positif, NAIK).",
                        "Jadi, fungsi naik pada interval $x<-2$ atau $x>2$."
                    ]
                },
                exercises: [
                    { id: 'ap1-2', problem: "Titik stasioner dari $f(x)=x^2-4x+1$ terjadi pada $x=...$", choices: ["4", "1", "2", "-2", "-4"], answer: '2', explanation: "Cari turunan: $f'(x)=2x-4$. Set $f'(x)=0 \\Rightarrow 2x-4=0 \\Rightarrow x=2$." }
                ]
            }
        ]
    },
    aplikasi2: {
        id: 'aplikasi2',
        title: 'Aplikasi Lanjutan & Optimisasi',
        sections: [
            {
                title: "Uji Turunan Kedua dan Kecekungan",
                content: "Turunan kedua, $f''(x)$, menentukan kecekungan kurva. Jika $f''(x)>0$, kurva cekung ke atas (seperti mangkok $\\cup$). Jika $f''(x)<0$, kurva cekung ke bawah (seperti mangkok $\\cap$). Uji ini juga bisa menentukan jenis titik stasioner: jika $f'(c)=0$ dan $f''(c)>0$, maka itu titik minimum.",
                example: {
                    problem: "Tentukan jenis titik stasioner dari $f(x) = x^3 - 6x^2$ menggunakan uji turunan kedua.",
                    solution: [
                        "$f'(x) = 3x^2 - 12x$. Titik stasioner saat $3x(x-4)=0$, yaitu di $x=0$ dan $x=4$.",
                        "$f''(x) = 6x-12$.",
                        "Uji $x=0$: $f''(0) = 6(0)-12 = -12$ (negatif). Maka $x=0$ adalah titik maksimum lokal.",
                        "Uji $x=4$: $f''(4) = 6(4)-12 = 12$ (positif). Maka $x=4$ adalah titik minimum lokal."
                    ]
                },
                exercises: [
                    { id: 'ap2-1', problem: "Interval di mana kurva $f(x)=x^3-6x^2$ cekung ke atas adalah...", choices: ["$x<2$", "$x>2$", "$x>0$", "$x<3$", "$x>3$"], answer: '$x>2$', explanation: "$f'(x)=3x^2-12x$ dan $f''(x)=6x-12$. Cekung ke atas saat $f''(x)>0 \\Rightarrow 6x-12>0 \\Rightarrow x>2$." }
                ]
            },
            {
                title: "Masalah Optimisasi (Maksimum/Minimum)",
                content: "Ini adalah aplikasi turunan untuk memecahkan masalah nyata. Langkahnya: buat model fungsi, cari turunannya, set turunan = 0, lalu selesaikan.",
                example: {
                    problem: "Dua bilangan jumlahnya 20. Tentukan kedua bilangan tersebut agar hasil kalinya maksimum.",
                    solution: [
                        "Misal bilangan itu $x$ dan $y$. Maka $x+y=20 \\Rightarrow y=20-x$.",
                        "Hasil kali, $K = x \\cdot y = x(20-x) = 20x - x^2$.",
                        "Agar maksimum, turunan $K$ harus nol: $K' = 20 - 2x = 0$.",
                        "Didapat $2x=20 \\Rightarrow x=10$.",
                        "Jika $x=10$, maka $y=20-10=10$. Kedua bilangan adalah 10 dan 10."
                    ]
                },
                exercises: [
                    { id: 'ap2-2', problem: "Sebuah persegi panjang memiliki keliling 100 m. Agar luasnya maksimum, panjangnya adalah...", choices: ["50", "100", "20", "25", "30"], answer: '25', explanation: "$2(p+l)=100 \\Rightarrow p+l=50 \\Rightarrow l=50-p$. Luas $L=pl=p(50-p)=50p-p^2$. $L'=50-2p=0 \\Rightarrow p=25$." }
                ]
            }
        ]
    }
};

// Bank soal untuk kuis
const quizBank = {
    konsepDasar: [
        { question: "Turunan pertama dari $f(x) = 15$ adalah...", options: ["0", "1", "15", "x"], answer: "0"},
        { question: "Notasi turunan yang diperkenalkan oleh Leibniz adalah...", options: ["$f'(x)$", "$y'$", "$\\frac{dy}{dx}$", "$D_x y$"], answer: "$\\frac{dy}{dx}$"},
        { question: "Turunan dari $f(x) = -8x$ adalah...", options: ["-8", "8", "-8x", "0"], answer: "-8"},
        { question: "Menggunakan definisi limit, turunan dari $f(x) = x^2$ adalah...", options: ["$x$", "$2x$", "$x^2$", "2"], answer: "$2x$"},
        { question: "Secara geometris, turunan di suatu titik merepresentasikan...", options: ["Luas di bawah kurva", "Panjang busur", "Volume benda putar", "Gradien garis singgung"], answer: "Gradien garis singgung"},
        { question: "Jika $f(x) = 2x+3$, maka $f'(1)$ adalah...", options: ["1", "2", "3", "5"], answer: "2"},
        { question: "Proses mencari turunan disebut...", options: ["Integrasi", "Diferensiasi", "Limitasi", "Substitusi"], answer: "Diferensiasi"},
        { question: "Turunan dari $f(x) = \\frac{1}{2}x$ adalah...", options: ["$x$", "2", "1/2", "0"], answer: "1/2"},
        { question: "Jika $f'(x) = 4$, maka fungsi $f(x)$ yang mungkin adalah...", options: ["$x^4$", "$4x^2$", "$4x+5$", "$x+4$"], answer: "$4x+5$"},
        { question: "Definisi turunan $f'(x)$ adalah $\\lim_{h \\to 0} \\frac{...}{h}$", options: ["$f(x+h)+f(x)$", "$f(x+h)-f(x)$", "$f(x)-f(x-h)$", "$f(x)h$"], answer: "$f(x+h)-f(x)$"},
    ],
    aturanDasar: [
        { question: "Turunan dari $f(x) = 3x^4$ adalah...", options: ["$12x^3$", "$7x^3$", "$12x^4$", "$3x^3$"], answer: "$12x^3$"},
        { question: "Turunan dari $f(x) = 2x^3 - 5x^2 + 7x - 1$ adalah...", options: ["$6x^2-10x+7$", "$3x^2-5x+7$", "$6x^3-10x^2+7$", "$2x^2-5x$"], answer: "$6x^2-10x+7$"},
        { question: "Turunan dari $f(x) = \\frac{1}{x^3}$ adalah...", options: ["$-3x^{-4}$", "$3x^{-2}$", "$x^{-4}$", "$-3x^2$"], answer: "$-3x^{-4}$"},
        { question: "Jika $u=2x$ dan $v=x+1$, turunan dari $uv$ adalah...", options: ["$4x+2$", "$2x+2$", "$4x$", "$2$"], answer: "$4x+2$"},
        { question: "Turunan dari $f(x) = (x+2)(x-1)$ adalah...", options: ["$2x+1$", "$2x-1$", "$x+1$", "$2x$"], answer: "$2x+1$"},
        { question: "Turunan dari $f(x) = \\frac{x}{x+1}$ adalah...", options: ["$\\frac{1}{(x+1)^2}$", "$\\frac{-1}{(x+1)^2}$", "1", "$\\frac{x}{(x+1)^2}$"], answer: "$\\frac{1}{(x+1)^2}$"},
        { question: "Turunan dari $f(x) = 5\\sqrt{x}$ adalah...", options: ["$\\frac{5}{2\\sqrt{x}}$", "$5x^{1/2}$", "$\\frac{5}{\\sqrt{x}}$", "$2.5x$"], answer: "$\\frac{5}{2\\sqrt{x}}$"},
        { question: "Jika $f'(x) = 3x^2$, fungsi $f(x)$ yang mungkin adalah...", options: ["$x^3$", "$6x$", "$3x^3$", "$x^2$"], answer: "$x^3$"},
        { question: "Turunan dari $f(x) = (2x^2-1)(x+3)$ adalah...", options: ["$6x^2+12x-1$", "$4x+1$", "$2x^2+4x-1$", "$6x^2-12x+1$"], answer: "$6x^2+12x-1$"},
        { question: "Turunan dari $f(x) = \\frac{3}{x}$ adalah...", options: ["$3x^{-2}$", "$-3x^{-2}$", "3", "$-3$"], answer: "$-3x^{-2}$"},
    ],
    trigoRantai: [
        { question: "Turunan dari $y = (3x+4)^5$ adalah...", options: ["$5(3x+4)^4$", "$15(3x+4)^4$", "$3(3x+4)^4$", "$5(3x+4)^5$"], answer: "$15(3x+4)^4$"},
        { question: "Turunan dari $y = \\sin(2x)$ adalah...", options: ["$2\\cos(2x)$", "$\\cos(2x)$", "$-2\\cos(2x)$", "$-\\cos(2x)$"], answer: "$2\\cos(2x)$"},
        { question: "Turunan dari $y = \\cos(x^2)$ adalah...", options: ["$-\\sin(x^2)$", "$2x\\sin(x^2)$", "$-2x\\sin(x^2)$", "$\\sin(2x)$"], answer: "$-2x\\sin(x^2)$"},
        { question: "Turunan dari $y = \\sqrt{2x+1}$ adalah...", options: ["$\\frac{1}{\\sqrt{2x+1}}$", "$\\frac{1}{2\\sqrt{2x+1}}$", "$\\sqrt{2}$", "$\\frac{2}{\\sqrt{2x+1}}$"], answer: "$\\frac{1}{\\sqrt{2x+1}}$"},
        { question: "Turunan dari $y = \\tan(3x)$ adalah...", options: ["$3\\sec^2(3x)$", "$\\sec^2(3x)$", "$3\\cot(3x)$", "$\\sec(3x)\\tan(3x)$"], answer: "$3\\sec^2(3x)$"},
        { question: "Jika $y = \\sin^3(x)$, maka $y'$ adalah...", options: ["$3\\sin^2(x)$", "$3\\cos^3(x)$", "$3\\sin^2(x)\\cos(x)$", "$\\cos^3(x)$"], answer: "$3\\sin^2(x)\\cos(x)$"},
        { question: "Turunan dari $y = (1-x^2)^6$ adalah...", options: ["$-12x(1-x^2)^5$", "$6(1-x^2)^5$", "$-2x(1-x^2)^5$", "$12x(1-x^2)^5$"], answer: "$-12x(1-x^2)^5$"},
        { question: "Turunan dari $y = \\sec(x)$ adalah...", options: ["$\\sec(x)\\tan(x)$", "$\\tan^2(x)$", "$-\\csc(x)$", "$\\sec^2(x)$"], answer: "$\\sec(x)\\tan(x)$"},
        { question: "Turunan dari $y = \\cos(2x+ \\pi)$ adalah...", options: ["$-2\\sin(2x+\\pi)$", "$-\\sin(2x+\\pi)$", "$2\\sin(2x+\\pi)$", "$2\\cos(2x)$"], answer: "$-2\\sin(2x+\\pi)$"},
        { question: "Turunan dari $y = (\\sin x + \\cos x)^2$ adalah...", options: ["$2(\\sin x + \\cos x)$", "$2(\\cos x - \\sin x)$", "$2\\cos(2x)$", "$1$"], answer: "$2\\cos(2x)$"},
    ],
    aplikasi1: [
        { question: "Gradien garis singgung kurva $y = 2x^2 - 3x + 1$ di $x=2$ adalah...", options: ["3", "5", "8", "1"], answer: "5"},
        { question: "Fungsi $f(x) = 5-4x-x^2$ turun pada interval...", options: ["$x>-2$", "$x<-2$", "$x>2$", "$x<2$"], answer: "$x>-2$"},
        { question: "Titik stasioner dari $f(x) = x^3 - 3x$ adalah...", options: ["$x=1$ dan $x=-1$", "$x=0$", "$x=3$ dan $x=-3$", "$x=\\sqrt{3}$"], answer: "$x=1$ dan $x=-1$"},
        { question: "Persamaan garis singgung kurva $y=x^2$ di titik $(2,4)$ adalah...", options: ["$y=4x-4$", "$y=2x$", "$y=4x$", "$y=2x+2$"], answer: "$y=4x-4$"},
        { question: "Fungsi $f(x)=x^3$ selalu... ", options: ["Naik", "Turun", "Stasioner", "Konstan"], answer: "Naik"},
        { question: "Nilai minimum lokal dari $f(x)=x^2-6x+5$ adalah...", options: ["-4", "5", "-3", "6"], answer: "-4"},
        { question: "Fungsi $f(x) = \\sin x$ untuk $0 < x < \\pi$ naik pada interval...", options: ["$0 < x < \\pi/2$", "$\\pi/2 < x < \\pi$", "$0 < x < \\pi$", "Tidak pernah naik"], answer: "$0 < x < \\pi/2$"},
        { question: "Garis $y=2x+1$ menyinggung kurva $y=x^2+c$ di $x=1$. Nilai $c$ adalah...", options: ["0", "1", "2", "-1"], answer: "2"},
        { question: "Nilai maksimum lokal dari $f(x) = 2x^3 - 3x^2 - 12x + 1$ terjadi di...", options: ["$x=-1$", "$x=2$", "$x=0$", "$x=1$"], answer: "$x=-1$"},
        { question: "Jika sebuah fungsi turun, maka turunan pertamanya...", options: ["Positif", "Negatif", "Nol", "Tidak terdefinisi"], answer: "Negatif"},
    ],
    aplikasi2: [
        { question: "Kurva $f(x)=x^3-3x^2+5$ cekung ke bawah pada interval...", options: ["$x>1$", "$x<1$", "$x>3$", "$x<3$"], answer: "$x<1$"},
        { question: "Titik belok dari fungsi $f(x) = x^3 - 6x^2 + 12x - 8$ terjadi di $x=...$", options: ["1", "2", "3", "4"], answer: "2"},
        { question: "Menggunakan uji turunan kedua, titik stasioner $x=0$ pada $f(x)=x^3-3x$ adalah...", options: ["Maksimum lokal", "Minimum lokal", "Titik belok", "Uji gagal"], answer: "Maksimum lokal"},
        { question: "Sebuah roket bergerak dengan posisi $s(t) = t^3 - 6t^2 + 9t$. Percepatannya saat $t=2$ adalah...", options: ["0", "6", "-6", "12"], answer: "0"},
        { question: "Dari selembar karton $8 \\times 8$ cm akan dibuat kotak tanpa tutup. Agar volume maksimum, tinggi kotak adalah...", options: ["$4/3$", "$2$", "$8/3$", "$1$"], answer: "$4/3$"},
        { question: "Jika $f'(2)=0$ dan $f''(2)=5$, maka di $x=2$ terjadi...", options: ["Maksimum lokal", "Minimum lokal", "Titik belok", "Asimtot"], answer: "Minimum lokal"},
        { question: "Biaya produksi $x$ barang adalah $C(x)=x^2-10x+100$. Biaya minimum terjadi saat memproduksi ... barang.", options: ["5", "10", "100", "20"], answer: "5"},
        { question: "Kecepatan partikel adalah $v(t) = 3t^2-4$. Percepatan partikel saat $t=1$ adalah...", options: ["6", "2", "-1", "3"], answer: "6"},
        { question: "Dua bilangan positif hasil kalinya 100. Agar jumlahnya minimum, bilangan tersebut adalah...", options: ["10 dan 10", "20 dan 5", "50 dan 2", "25 dan 4"], answer: "10 dan 10"},
        { question: "Kurva $y = \\cos x$ untuk $0 < x < 2\\pi$ cekung ke atas pada interval...", options: ["$\\pi/2 < x < 3\\pi/2$", "$0 < x < \\pi$", "$0 < x < \\pi/2$", "$\\pi < x < 2\\pi$"], answer: "$\\pi/2 < x < 3\\pi/2$"},
    ]
};

// Bank Soal Ujian Akhir (BARU) - Sedikit lebih sulit
const finalExamBank = {
    konsepDasar: [
        { question: "Menggunakan definisi limit, turunan dari $f(x) = x^3$ adalah...", options: ["$3x$", "$x^2$", "$3x^2$", "$x^3/3$"], answer: "$3x^2$"},
        { question: "Menggunakan definisi limit, turunan dari $f(x) = 1/x$ adalah...", options: ["$-1/x^2$", "1", "$-1/x$", "$1/x^2$"], answer: "$-1/x^2$"},
        { question: "Jika $f(x)=k$ (konstanta), maka $f'(a)$ untuk $a$ berapapun adalah...", options: ["$k$", "0", "$a$", "$ka$"], answer: "0"},
        { question: "Turunan dari $f(x) = 3x^2$ di $x=5$ adalah...", options: ["15", "75", "30", "25"], answer: "30"},
        { question: "Notasi $D_x[f(x)]$ ekuivalen dengan...", options: ["$\\int f(x) dx$", "$f'(x)$", "$f(x) dx$", "$f(x) + C$"], answer: "$f'(x)$"},
    ],
    aturanDasar: [
        { question: "Turunan dari $f(x) = (x^2+1)(2x-3)$ adalah...", options: ["$6x^2-6x+2$", "$4x$", "$6x^2+6x-2$", "$4x^2-3x+2$"], answer: "$6x^2-6x+2$"},
        { question: "Turunan dari $f(x) = \\frac{x^2}{x-1}$ adalah...", options: ["$2x$", "$\\frac{x^2-2x}{(x-1)^2}$", "$\\frac{2x}{(x-1)^2}$", "$\\frac{3x^2-2x}{(x-1)^2}$"], answer: "$\\frac{x^2-2x}{(x-1)^2}$"},
        { question: "Turunan dari $f(x) = 4\\sqrt[4]{x^3}$ adalah...", options: ["$3x^{-1/4}$", "$4x^{-1/4}$", "$3x^{3/4}$", "$4x^{-1/3}$"], answer: "$3x^{-1/4}$"},
        { question: "Jika $f(x) = \\frac{2x+1}{3x-2}$, maka $f'(1)$ adalah...", options: ["-7", "7", "-4", "1"], answer: "-7"},
        { question: "Turunan dari $f(x) = (2x+1)^2$ adalah...", options: ["$2(2x+1)$", "$4(2x+1)$", "4", "8x"], answer: "$4(2x+1)$"},
    ],
    trigoRantai: [
        { question: "Turunan dari $y = \\cos^3(x)$ adalah...", options: ["$-3\\cos^2(x)\\sin(x)$", "$3\\cos^2(x)$", "$3\\sin^2(x)$", "$-3\\sin^2(x)$"], answer: "$-3\\cos^2(x)\\sin(x)$"},
        { question: "Turunan dari $y = \\sin(x^2+2x)$ adalah...", options: ["$\\cos(x^2+2x)$", "$(2x+2)\\cos(x^2+2x)$", "$2x+2$", "$-\\cos(x^2+2x)$"], answer: "$(2x+2)\\cos(x^2+2x)$"},
        { question: "Turunan dari $y = \\frac{1}{\\sqrt{x^2+1}}$ adalah...", options: ["$x(x^2+1)^{-3/2}$", "$-x(x^2+1)^{-3/2}$", "$-(x^2+1)^{-3/2}$", "$x(x^2+1)^{-1/2}$"], answer: "$-x(x^2+1)^{-3/2}$"},
        { question: "Jika $f(x) = \\tan(2x)$, maka $f'(\\pi/8)$ adalah...", options: ["2", "4", "1/2", "1"], answer: "4"},
        { question: "Turunan dari $f(x) = x^2 \\cos(x)$ adalah...", options: ["$2x\\cos(x) - x^2\\sin(x)$", "$2x\\sin(x) + x^2\\cos(x)$", "$-2x\\sin(x)$", "$2x\\cos(x) + x^2\\sin(x)$"], answer: "$2x\\cos(x) - x^2\\sin(x)$"},
    ],
    aplikasi1: [
        { question: "Persamaan garis normal dari kurva $y=x^2$ di $x=1$ adalah...", options: ["$y = -\\frac{1}{2}x + \\frac{3}{2}$", "$y = 2x-1$", "$y = -2x+3$", "$y = \\frac{1}{2}x + \\frac{1}{2}$"], answer: "$y = -\\frac{1}{2}x + \\frac{3}{2}$"},
        { question: "Fungsi $f(x) = x^3-6x^2+9x+1$ turun pada interval...", options: ["$x<1$ atau $x>3$", "$1<x<3$", "$x< -1$ atau $x > -3$", "$-3<x<-1$"], answer: "$1<x<3$"},
        { question: "Nilai maksimum lokal dari $f(x) = x^3-3x^2+1$ adalah...", options: ["1", "3", "-3", "0"], answer: "1"},
        { question: "Sebuah partikel bergerak dengan posisi $s(t) = 2t^3 - t^2$. Kecepatan partikel saat $t=2$ adalah...", options: ["16", "20", "22", "8"], answer: "20"},
        { question: "Titik stasioner dari $f(x) = \\cos(x)$ pada $0 < x < 2\\pi$ adalah...", options: ["$x = \\pi/2$", "$x = 3\\pi/2$", "$x = \\pi$", "$x = \\pi/2$ dan $x = 3\\pi/2$"], answer: "$x = \\pi$"},
    ],
    aplikasi2: [
        { question: "Titik belok dari kurva $f(x) = x^3 - 3x^2$ terjadi di $x=...$", options: ["0", "1", "2", "3"], answer: "1"},
        { question: "Kurva $f(x) = \\sin(x)$ untuk $0 < x < 2\\pi$ cekung ke bawah pada interval...", options: ["$0 < x < \\pi$", "$\\pi < x < 2\\pi$", "$0 < x < \\pi/2$", "$\\pi/2 < x < 3\\pi/2$"], answer: "$0 < x < \\pi$"},
        { question: "Posisi partikel adalah $s(t) = t^3 - 3t^2 + 5$. Percepatan partikel saat $t=3$ adalah...", options: ["12", "9", "18", "6"], answer: "12"},
        { question: "Sebuah kotak tanpa tutup dibuat dari selembar karton $12 \\times 12$ cm. Volume maksimum kotak terjadi saat tinggi kotak $x=...$", options: ["1", "2", "3", "4"], answer: "2"},
        { question: "Jika $f'(1)=0$ dan $f''(1)=-4$, maka $f(x)$ di $x=1$ adalah...", options: ["Minimum lokal", "Maksimum lokal", "Titik belok", "Cekung ke atas"], answer: "Maksimum lokal"},
    ]
};


// Bank Soal Tantangan
const challengeBank = [
    { 
        id: 'ch1', 
        question: "Sebuah tangga sepanjang 5 meter bersandar pada dinding vertikal. Ujung bawah tangga ditarik menjauhi dinding dengan kecepatan konstan 2 m/s. Seberapa cepat ujung atas tangga meluncur ke bawah saat ujung bawah tangga berjarak 3 meter dari dinding?",
        choices: ["-1 m/s", "-1.5 m/s", "-2 m/s", "-2.5 m/s", "-3 m/s"],
        answer: "-1.5 m/s",
        clue: "Gunakan teorema Pythagoras untuk menghubungkan posisi ujung atas dan bawah tangga. Lalu, turunkan persamaan tersebut terhadap waktu (turunan implisit).",
        points: 30
    },
    { 
        id: 'ch2', 
        question: "Carilah turunan ke-2025 dari fungsi $f(x) = x \\sin x$.",
        choices: ["$x \\sin x + 2025 \\cos x$", "$x \\cos x - 2025 \\sin x$", "$-x \\sin x - 2025 \\cos x$", "$-x \\cos x + 2025 \\sin x$", "$2025 \\sin x$"],
        answer: "$-x \\cos x + 2025 \\sin x$",
        clue: "Gunakan Aturan Leibniz untuk turunan tingkat tinggi dari perkalian dua fungsi: $(uv)^{(n)} = \\sum_{k=0}^{n} \\binom{n}{k} u^{(k)} v^{(n-k)}$. Perhatikan pola turunan $\\sin x$ dan $\\cos x$.",
        points: 35
    },
    { 
        id: 'ch3', 
        question: "Titik pada kurva $y = \\sqrt{x}$ yang paling dekat dengan titik $(4, 0)$ adalah...",
        choices: ["$(2, \\sqrt{2})$", "$(3.5, \\sqrt{3.5})$", "$(4, 2)$", "$(1, 1)$", "$(2.5, \\sqrt{2.5})$"],
        answer: "$(3.5, \\sqrt{3.5})$",
        clue: "Jarak antara titik $(x, y)$ pada kurva dan $(4, 0)$ adalah $D = \\sqrt{(x-4)^2 + (y-0)^2}$. Substitusi $y=\\sqrt{x}$. Untuk meminimalkan $D$, cukup minimalkan $D^2$. Cari turunan $D^2$ terhadap $x$ dan set sama dengan nol.",
        points: 35
    },
];


// --- STATE APLIKASI ---
let appState = {
    studentName: '',
    studentClass: '',
    reviewProgress: {},
    quizState: null,
    examPracticeState: null, 
    challengeState: null,
    finalExamState: null, // State untuk Ujian Turunan (BARU)
    finalExamCompleted: false // Status Ujian Turunan (BARU)
};

// --- FUNGSI UTAMA ---
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    updateStudentInfoDisplay();
    if (pageId === 'main-menu-page') initMainMenu();
}

function showModal(modalId) { document.getElementById(modalId).classList.add('active'); }
function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
function saveState() { localStorage.setItem(APP_STATE_KEY, JSON.stringify(appState)); }
function loadState() {
    const savedState = localStorage.getItem(APP_STATE_KEY);
    if (savedState) appState = JSON.parse(savedState);
    // Inisialisasi state baru jika tidak ada di local storage
    if (appState.finalExamState === undefined) appState.finalExamState = null;
    if (appState.finalExamCompleted === undefined) appState.finalExamCompleted = false;
}

// --- LOGIKA LOGIN & MENU UTAMA ---
function login() {
    const name = document.getElementById('student-name').value.trim();
    const sClass = document.getElementById('student-class').value;
    if (!name || !sClass) {
        document.getElementById('login-error').classList.remove('hidden');
        return;
    }
    // Cek jika nama siswa berbeda, reset semua progress
    if(appState.studentName !== name) {
        appState = {
            studentName: name,
            studentClass: sClass,
            reviewProgress: {},
            quizState: null,
            examPracticeState: null, 
            challengeState: null,
            finalExamState: null, 
            finalExamCompleted: false
        };
    } else {
        // Jika nama sama, cukup update nama dan kelas (jika berubah)
        appState.studentName = name;
        appState.studentClass = sClass;
    }
    saveState();
    showPage('main-menu-page');
}


function initMainMenu() {
    const container = document.getElementById('review-buttons-container');
    container.innerHTML = '';
    let topicCounter = 1;

    Object.values(reviewData).forEach(topic => {
        const progress = appState.reviewProgress[topic.id] || [];
        const totalExercises = topic.sections.reduce((sum, sec) => sum + sec.exercises.length, 0);
        const isDone = progress.length >= totalExercises;

        const buttonHTML = `
            <button onclick="loadReviewContent('${topic.id}')" class="p-4 rounded-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-1 flex items-center justify-start gap-4 w-full ${isDone ? 'bg-green-600' : 'bg-indigo-600'} text-white text-left">
                <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-white/20 rounded-full font-bold text-lg">${topicCounter}</span>
                <span class="font-semibold">${topic.title}</span>
                ${isDone ? '<span class="ml-auto text-2xl text-white">‚úì</span>' : ''}
            </button>
        `;
        container.innerHTML += buttonHTML;
        topicCounter++;
    });

    // Update Tombol Latihan Ujian (selalu aktif, hapus "paksa")
    const startExamButton = document.getElementById('start-exam-button');
    startExamButton.disabled = false;
    startExamButton.innerHTML = 'Latihan Ujian'; // Hapus ikon

    // Sembunyikan tombol "Paksa"
    // (Tombolnya sudah dihapus dari HTML)

    // Logika untuk Tombol UJIAN TURUNAN
    const finalExamButton = document.getElementById('start-final-exam-button');
    const viewFinalExamReportButton = document.getElementById('view-final-exam-report-button');
    if (appState.finalExamCompleted) {
        finalExamButton.classList.add('hidden');
        viewFinalExamReportButton.classList.remove('hidden');
    } else {
        finalExamButton.classList.remove('hidden');
        viewFinalExamReportButton.classList.add('hidden');
    }
}

function showForceExamModal() {
    showModal('force-exam-modal');
}

function showChallengeConfirmationModal() {
    showModal('confirm-challenge-modal');
}

function showFinalExamConfirmationModal() {
    showModal('confirm-final-exam-modal');
}


function updateStudentInfoDisplay() {
    if (appState.studentName) {
        const nameSpans = document.querySelectorAll('[id^="student-name-display"]');
        const classSpans = document.querySelectorAll('[id^="student-class-display"]');
        nameSpans.forEach(span => span.textContent = appState.studentName);
        classSpans.forEach(span => span.textContent = appState.studentClass);
    }
}

// --- LOGIKA REVIEW MATERI ---
function loadReviewContent(topicId) {
    const topic = reviewData[topicId];
    document.getElementById('review-header').innerHTML = `<h1 class="text-4xl font-bold text-gray-800">${topic.title}</h1>`;
    const contentContainer = document.getElementById('review-content');
    contentContainer.innerHTML = '';

    topic.sections.forEach(section => {
        let exercisesHTML = section.exercises.map(ex => {
            const choicesHTML = ex.choices.map(choice => 
                // Gunakan textContent untuk menyimpan jawaban asli sebelum MathJax
                `<button class="exercise-option" data-choice="${choice.replace(/"/g, '&quot;')}" onclick="selectExerciseOption(this)">${choice}</button>`
            ).join('');

            return `
                <div class="latihan-mandiri mt-4 pt-4 border-t" data-exercise-id="${ex.id}">
                    <h5 class="font-semibold text-sm text-gray-600 mb-2">${ex.problem}</h5>
                    <div class="exercise-options-container flex flex-col gap-2 my-2">${choicesHTML}</div>
                    <div class="flex items-center gap-2">
                        <button data-state="check" onclick="checkExerciseAnswer(this, '${topicId}', '${ex.id}')" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600 transition disabled:bg-slate-400 disabled:cursor-not-allowed disabled:hover:bg-slate-400">Cek</button>
                    </div>
                    <div class="feedback-box mt-2"></div>
                </div>
            `;
        }).join('');

        contentContainer.innerHTML += `
            <div class="content-card p-6">
                <h3 class="text-2xl font-bold text-indigo-700 mb-3">${section.title}</h3>
                <p class="mb-4 text-slate-600">${section.content}</p>
                <div class="bg-slate-50 p-4 rounded-lg">
                    <h4 class="font-semibold">Contoh:</h4>
                    <p class="my-2 text-lg">${section.example.problem}</p>
                    <div class="solution-toggle bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold p-2 rounded-md text-sm inline-block cursor-pointer" onclick="toggleSolution(this)">Lihat Pembahasan</div>
                    <div class="solution-content">${section.example.solution.map(s => `<p>${s}</p>`).join('')}</div>
                </div>
                ${exercisesHTML}
            </div>
        `;
    });
    
    contentContainer.innerHTML += `
        <div id="quiz-button-container" class="hidden text-center content-card p-6 mt-8">
            <h3 class="text-2xl font-bold text-green-600">Materi Selesai!</h3>
            <p class="text-slate-600 mt-2">Kamu sudah siap untuk menguji pemahamanmu di subbab ini.</p>
            <button onclick="startQuiz('${topicId}')" class="mt-4 bg-emerald-600 text-white font-semibold py-3 px-6 rounded-full shadow hover:bg-emerald-700 transition transform hover:scale-105">
                Mulai Kuis: ${topic.title}
            </button>
        </div>
    `;

    showPage('review-page');
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
    
    // Restore state for completed exercises
    (appState.reviewProgress[topicId] || []).forEach(exerciseId => {
        const exerciseEl = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
        if (exerciseEl) {
            const correctExercise = reviewData[topicId].sections.flatMap(s => s.exercises).find(e => e.id === exerciseId);
            if (correctExercise) {
                const optionButtons = exerciseEl.querySelectorAll('.exercise-option');
                optionButtons.forEach(btn => {
                    btn.disabled = true;
                    // Bandingkan dengan data-choice
                    if (btn.dataset.choice === correctExercise.answer) {
                        btn.classList.add('correct');
                    }
                });
                const checkButton = exerciseEl.querySelector('[data-state]');
                checkButton.innerHTML = 'Selesai ‚úì';
                checkButton.disabled = true;
            }
        }
    });
    checkReviewCompletion(topicId);
}

function selectExerciseOption(buttonEl) {
    const optionContainer = buttonEl.parentElement;
    optionContainer.querySelectorAll('.exercise-option').forEach(btn => btn.classList.remove('selected'));
    buttonEl.classList.add('selected');
}

function checkReviewCompletion(topicId) {
    const topic = reviewData[topicId];
    const progress = appState.reviewProgress[topicId] || [];
    const totalExercises = topic.sections.reduce((sum, sec) => sum + sec.exercises.length, 0);
    if (progress.length >= totalExercises) {
        document.getElementById('quiz-button-container').classList.remove('hidden');
    }
}

function toggleSolution(element) {
    const solutionContent = element.nextElementSibling;
    solutionContent.style.display = solutionContent.style.display === 'block' ? 'none' : 'block';
    element.textContent = solutionContent.style.display === 'block' ? 'Sembunyikan Pembahasan' : 'Lihat Pembahasan';
    if(solutionContent.style.display === 'block' && window.MathJax) {
        MathJax.typesetPromise([solutionContent]);
    }
}

function checkExerciseAnswer(buttonEl, topicId, exerciseId) {
    const exerciseContainer = buttonEl.closest('.latihan-mandiri');
    const feedbackBox = exerciseContainer.querySelector('.feedback-box');
    const selectedOption = exerciseContainer.querySelector('.exercise-option.selected');
    const allOptions = exerciseContainer.querySelectorAll('.exercise-option');

    const exercise = reviewData[topicId].sections.flatMap(s => s.exercises).find(e => e.id === exerciseId);
    if (!exercise) return;
    const { answer: correctAnswer, explanation } = exercise;

    if (buttonEl.dataset.state === 'retry') {
        allOptions.forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('incorrect', 'selected');
        });
        feedbackBox.innerHTML = '';
        buttonEl.textContent = 'Cek';
        buttonEl.dataset.state = 'check';
        return;
    }

    if (!selectedOption) {
        feedbackBox.innerHTML = `<div class="p-3 bg-yellow-50 rounded-md border border-yellow-200"><p class="font-bold text-yellow-700">Pilih salah satu jawaban terlebih dahulu!</p></div>`;
        return;
    }

    // Gunakan data-choice untuk perbandingan
    const userAnswer = selectedOption.dataset.choice;

    if (userAnswer === correctAnswer) {
        feedbackBox.innerHTML = `<div class="p-3 bg-green-50 rounded-md border border-green-200"><p class="font-bold text-green-600">Benar!</p><p class="text-slate-800">${explanation}</p></div>`;
        
        selectedOption.classList.remove('selected');
        selectedOption.classList.add('correct');

        allOptions.forEach(btn => btn.disabled = true);

        buttonEl.innerHTML = 'Selesai ‚úì';
        buttonEl.disabled = true;
        buttonEl.classList.add('bg-slate-400', 'cursor-not-allowed', 'hover:bg-slate-400');


        if (!appState.reviewProgress[topicId]) appState.reviewProgress[topicId] = [];
        if (!appState.reviewProgress[topicId].includes(exerciseId)) {
            appState.reviewProgress[topicId].push(exerciseId);
            saveState();
        }
        checkReviewCompletion(topicId);
    } else {
        feedbackBox.innerHTML = `<div class="p-3 bg-red-50 rounded-md border border-red-200"><p class="font-bold text-red-600">Kurang Tepat.</p><p class="text-slate-800 mt-2">${explanation}</p></div>`;
        selectedOption.classList.add('incorrect');
        
        allOptions.forEach(btn => btn.disabled = true); // Tetap disable

        buttonEl.textContent = 'Coba Lagi';
        buttonEl.dataset.state = 'retry';
        
        // Aktifkan kembali opsi setelah jawaban salah
         allOptions.forEach(btn => btn.disabled = false); 
         // Kecuali yang salah
         selectedOption.disabled = false; // Biarkan yang salah bisa diklik lagi (opsional) atau direset

    }
    if (window.MathJax) {
        MathJax.typesetPromise([feedbackBox]);
    }
}


// --- LOGIKA KUIS ---
let quizTimerInterval;
function startQuiz(topicId) {
    appState.quizState = {
        topicId: topicId,
        questions: quizBank[topicId],
        userAnswers: Array(10).fill(null),
        currentQuestionIndex: 0,
        remainingTime: 20 * 60 // 20 Menit
    };
    
    showPage('quiz-page');
    displayQuizQuestion(0);
    startQuizTimer();
}

function displayQuizQuestion(index) {
    appState.quizState.currentQuestionIndex = index;
    const q = appState.quizState.questions[index];
    document.getElementById('quiz-current-question-number').textContent = index + 1;
    document.getElementById('quiz-question-text').textContent = q.question;
    
    const optionsContainer = document.getElementById('quiz-options-container');
    optionsContainer.innerHTML = '';
    const optionLetters = ['A', 'B', 'C', 'D'];
    q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'option-button p-4 border-2 rounded-lg flex items-center gap-4 text-left';
        btn.innerHTML = `<span class="font-bold">${optionLetters[i]}.</span><span>${opt}</span>`;
        btn.onclick = () => selectQuizOption(opt);
        if (appState.quizState.userAnswers[index] === opt) btn.classList.add('selected');
        optionsContainer.appendChild(btn);
    });
    
    updateQuizQuestionPanel();
    updateQuizNavButtons();
    if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('quiz-question-area')]);
    }
}

function selectQuizOption(option) {
    const index = appState.quizState.currentQuestionIndex;
    appState.quizState.userAnswers[index] = option;
    displayQuizQuestion(index);
}

function updateQuizQuestionPanel() {
    const panel = document.getElementById('quiz-question-panel');
    panel.innerHTML = '';
    for (let i = 0; i < 10; i++) {
        const item = document.createElement('div');
        item.className = 'question-panel-item';
        item.textContent = i + 1;
        item.onclick = () => displayQuizQuestion(i);
        if (i === appState.quizState.currentQuestionIndex) item.classList.add('current');
        else if (appState.quizState.userAnswers[i] !== null) item.classList.add('answered');
        panel.appendChild(item);
    }
}

function updateQuizNavButtons() {
    const prevBtn = document.getElementById('quiz-prev-button');
    const nextBtn = document.getElementById('quiz-next-button');
    prevBtn.disabled = appState.quizState.currentQuestionIndex === 0;
    nextBtn.disabled = appState.quizState.currentQuestionIndex === 9;
    prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
    nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
}

function handleQuizNav(direction) {
    let newIndex = appState.quizState.currentQuestionIndex + direction;
    if (newIndex >= 0 && newIndex < 10) displayQuizQuestion(newIndex);
}

function startQuizTimer() {
    if(quizTimerInterval) clearInterval(quizTimerInterval);
    quizTimerInterval = setInterval(() => {
        if (!appState.quizState) { // Tambahan: Cek jika quizState ada
             clearInterval(quizTimerInterval);
             return;
        }
        appState.quizState.remainingTime--;
        const mins = Math.floor(appState.quizState.remainingTime / 60);
        const secs = appState.quizState.remainingTime % 60;
        document.getElementById('quiz-timer').textContent = `Waktu: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        if (appState.quizState.remainingTime <= 0) finishQuiz();
    }, 1000);
}

function confirmFinishQuiz() {
    const unanswered = appState.quizState.userAnswers.filter(a => a === null).length;
    const message = unanswered > 0 ? `Masih ada ${unanswered} soal belum dijawab. Yakin kumpulkan?` : 'Yakin ingin mengumpulkan?';
    document.getElementById('confirm-submit-message').textContent = message;
    // Set action for Yes button specifically for Quiz
    document.getElementById('confirm-submit-yes-button').onclick = finishQuiz;
    showModal('confirm-submit-modal');
}

function finishQuiz() {
    closeModal('confirm-submit-modal');
    clearInterval(quizTimerInterval);
    showPage('report-page');
    generateQuizReport();
}

// --- LOGIKA LAPORAN KUIS ---
function generateQuizReport() {
    document.getElementById('result-name').textContent = appState.studentName;
    document.getElementById('result-class').textContent = appState.studentClass;
    const topicId = appState.quizState.topicId;
    document.getElementById('quiz-topic-title').textContent = reviewData[topicId].title;

    let correctAnswers = 0;
    appState.quizState.questions.forEach((q, i) => {
        if (q.answer === appState.quizState.userAnswers[i]) correctAnswers++;
    });

    const totalScore = correctAnswers * 10; // 10 soal, 10 poin/soal
    document.getElementById('final-score').textContent = totalScore;
    
    let message = totalScore >= 70 ? "Bagus! Kamu menguasai subbab ini!" : "Ayo pelajari lagi dan coba kembali!";
    document.getElementById('result-message').textContent = message;
    
    renderQuizReportDetails();
    document.getElementById('retry-quiz-button').onclick = () => startQuiz(topicId);
}

function renderQuizReportDetails() {
    const container = document.getElementById('summary-container');
    container.innerHTML = '';
    appState.quizState.questions.forEach((q, i) => {
        const userAnswer = appState.quizState.userAnswers[i];
        const isCorrect = q.answer === userAnswer;
        const cardClass = isCorrect ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300';
        
        container.innerHTML += `
            <div class="p-4 rounded-lg border ${cardClass}">
                <p class="font-bold mb-2">Soal ${i + 1}</p>
                <div class="text-sm mb-2">${q.question}</div>
                <p class="text-sm mt-4">Jawaban Anda: <span class="font-semibold">${userAnswer || 'Tidak dijawab'}</span></p>
                ${!isCorrect ? `<p class="text-sm text-green-700">Jawaban Benar: <span class="font-semibold">${q.answer}</span></p>` : ''}
            </div>
        `;
    });
    if (window.MathJax) {
        MathJax.typesetPromise([container]);
    }
}

// --- LOGIKA LATIHAN UJIAN ---
let examTimerInterval;

function shuffleAndPick(arr, count) {
    const shuffled = [...arr].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
}

function startExamPractice(isForced = false) { // isForced sekarang selalu true dari tombol
    closeModal('force-exam-modal'); 
   
    // Ambil soal ujian
    const examQuestions = [];
    Object.keys(quizBank).forEach(topicId => {
        // Ambil 5 soal acak dari setiap bank soal kuis
        examQuestions.push(...shuffleAndPick(quizBank[topicId], 5));
    });
     // Acak urutan 20 soal gabungan
    const finalExamQuestions = shuffleAndPick(examQuestions, 20);


    appState.examPracticeState = {
        questions: finalExamQuestions,
        userAnswers: Array(20).fill(null),
        currentQuestionIndex: 0,
        remainingTime: 40 * 60 // 40 Menit untuk 20 soal
    };
    
    showPage('exam-practice-page');
    displayExamQuestion(0);
    startExamTimer();
}

function displayExamQuestion(index) {
    appState.examPracticeState.currentQuestionIndex = index;
    const q = appState.examPracticeState.questions[index];
    document.getElementById('exam-current-question-number').textContent = index + 1;
    document.getElementById('exam-question-text').textContent = q.question;
    
    const optionsContainer = document.getElementById('exam-options-container');
    optionsContainer.innerHTML = '';
    const optionLetters = ['A', 'B', 'C', 'D'];
    q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'option-button p-4 border-2 rounded-lg flex items-center gap-4 text-left';
        btn.innerHTML = `<span class="font-bold">${optionLetters[i]}.</span><span>${opt}</span>`;
        btn.onclick = () => selectExamOption(opt);
        if (appState.examPracticeState.userAnswers[index] === opt) btn.classList.add('selected');
        optionsContainer.appendChild(btn);
    });
    
    updateExamQuestionPanel();
    updateExamNavButtons();
    if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('exam-question-area')]);
    }
}

function selectExamOption(option) {
    const index = appState.examPracticeState.currentQuestionIndex;
    appState.examPracticeState.userAnswers[index] = option;
    displayExamQuestion(index);
}

function updateExamQuestionPanel() {
    const panel = document.getElementById('exam-question-panel');
    panel.innerHTML = '';
    for (let i = 0; i < 20; i++) { // Jumlah soal ujian = 20
        const item = document.createElement('div');
        item.className = 'question-panel-item';
        item.textContent = i + 1;
        item.onclick = () => displayExamQuestion(i);
        if (i === appState.examPracticeState.currentQuestionIndex) item.classList.add('current');
        else if (appState.examPracticeState.userAnswers[i] !== null) item.classList.add('answered');
        panel.appendChild(item);
    }
}

function updateExamNavButtons() {
    const prevBtn = document.getElementById('exam-prev-button');
    const nextBtn = document.getElementById('exam-next-button');
    prevBtn.disabled = appState.examPracticeState.currentQuestionIndex === 0;
    nextBtn.disabled = appState.examPracticeState.currentQuestionIndex === 19; // Indeks terakhir = 19
    prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
    nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
}

function handleExamNav(direction) {
    let newIndex = appState.examPracticeState.currentQuestionIndex + direction;
    if (newIndex >= 0 && newIndex < 20) displayExamQuestion(newIndex);
}

function startExamTimer() {
    if(examTimerInterval) clearInterval(examTimerInterval);
    examTimerInterval = setInterval(() => {
        if (!appState.examPracticeState) { // Tambahan: Cek jika state ada
             clearInterval(examTimerInterval);
             return;
        }
        appState.examPracticeState.remainingTime--;
        const mins = Math.floor(appState.examPracticeState.remainingTime / 60);
        const secs = appState.examPracticeState.remainingTime % 60;
        document.getElementById('exam-timer').textContent = `Waktu: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        if (appState.examPracticeState.remainingTime <= 0) finishExamPractice();
    }, 1000);
}

function confirmFinishExamPractice() {
    const unanswered = appState.examPracticeState.userAnswers.filter(a => a === null).length;
    const message = unanswered > 0 ? `Masih ada ${unanswered} soal belum dijawab. Yakin kumpulkan Latihan Ujian?` : 'Yakin ingin mengumpulkan Latihan Ujian?';
    document.getElementById('confirm-submit-message').textContent = message;
     // Set action for Yes button specifically for Exam Practice
    document.getElementById('confirm-submit-yes-button').onclick = finishExamPractice;
    showModal('confirm-submit-modal');
}

function finishExamPractice() {
    closeModal('confirm-submit-modal');
    clearInterval(examTimerInterval);
    showPage('exam-report-page');
    generateExamReport();
}

// --- LOGIKA LAPORAN LATIHAN UJIAN ---
function generateExamReport() {
    document.getElementById('exam-result-name').textContent = appState.studentName;
    document.getElementById('exam-result-class').textContent = appState.studentClass;

    let correctAnswers = 0;
    appState.examPracticeState.questions.forEach((q, i) => {
        if (q.answer === appState.examPracticeState.userAnswers[i]) correctAnswers++;
    });

    const totalScore = correctAnswers * 5; // 20 soal, 5 poin/soal
    document.getElementById('exam-final-score').textContent = totalScore;
    
    let message = totalScore >= 70 ? "Selamat! Kamu sudah siap menghadapi ujian!" : "Perlu latihan lagi, terus semangat!";
    document.getElementById('exam-result-message').textContent = message;
    
    renderExamReportDetails();
}

function renderExamReportDetails() {
    const container = document.getElementById('exam-summary-container');
    container.innerHTML = '';
    appState.examPracticeState.questions.forEach((q, i) => {
        const userAnswer = appState.examPracticeState.userAnswers[i];
        const isCorrect = q.answer === userAnswer;
        const cardClass = isCorrect ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300';
        
        container.innerHTML += `
            <div class="p-4 rounded-lg border ${cardClass}">
                <p class="font-bold mb-2">Soal ${i + 1}</p>
                <div class="text-sm mb-2">${q.question}</div>
                <p class="text-sm mt-4">Jawaban Anda: <span class="font-semibold">${userAnswer || 'Tidak dijawab'}</span></p>
                ${!isCorrect ? `<p class="text-sm text-green-700">Jawaban Benar: <span class="font-semibold">${q.answer}</span></p>` : ''}
            </div>
        `;
    });
    if (window.MathJax) {
        MathJax.typesetPromise([container]);
    }
}

// --- LOGIKA TANTANGAN ---
let challengeTimerInterval;

function startChallenge() {
    closeModal('confirm-challenge-modal'); // Tutup modal konfirmasi

    appState.challengeState = {
        questions: challengeBank, // Tidak perlu diacak karena hanya 3
        userAnswers: Array(3).fill(null),
        answerStatus: Array(3).fill(null), // null, 'correct', 'incorrect'
        cluesUsed: Array(3).fill(false),
        currentQuestionIndex: 0,
        remainingTime: 30 * 60 // 30 Menit
    };

    showPage('challenge-page');
    displayChallengeQuestion(0);
    startChallengeTimer();
}

function displayChallengeQuestion(index) {
    appState.challengeState.currentQuestionIndex = index;
    const q = appState.challengeState.questions[index];
    document.getElementById('challenge-current-question-number').textContent = index + 1;
    document.getElementById('challenge-question-text').textContent = q.question;
    
    const optionsContainer = document.getElementById('challenge-options-container');
    optionsContainer.innerHTML = '';
    const optionLetters = ['A', 'B', 'C', 'D', 'E']; // 5 Opsi
    q.choices.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'option-button p-4 border-2 rounded-lg flex items-center gap-4 text-left';
        btn.innerHTML = `<span class="font-bold">${optionLetters[i]}.</span><span>${opt}</span>`;
        btn.onclick = () => selectChallengeOption(btn, opt); 
        
        // Pulihkan state jika sudah dijawab
        if(appState.challengeState.userAnswers[index] === opt){
             btn.classList.add('selected'); // Tampilkan pilihan sebelumnya
             if(appState.challengeState.answerStatus[index] === 'correct') {
                 btn.classList.add('feedback-correct');
                 optionsContainer.querySelectorAll('.option-button').forEach(b => b.disabled = true); // Disable semua jika benar
             } else if (appState.challengeState.answerStatus[index] === 'incorrect') {
                 btn.classList.add('feedback-incorrect');
                 optionsContainer.querySelectorAll('.option-button').forEach(b => b.disabled = true); // Disable semua jika salah
             }
        } else if (appState.challengeState.answerStatus[index] !== null) {
            btn.disabled = true; // Disable opsi lain jika sudah dijawab
        }
        
        optionsContainer.appendChild(btn);
    });
    
    updateChallengeQuestionPanel();
    updateChallengeNavButtons();

     // Atur tombol Clue
    const clueButton = document.getElementById('clue-button');
    const clueBox = document.getElementById('clue-box');
    clueButton.disabled = appState.challengeState.cluesUsed[index];
    if (appState.challengeState.cluesUsed[index]) {
        clueBox.textContent = q.clue;
        clueBox.style.display = 'block';
    } else {
        clueBox.style.display = 'none';
    }

    // Reset feedback box
    document.getElementById('challenge-feedback-box').textContent = '';
    
    if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('challenge-question-area')]);
    }
}

function selectChallengeOption(buttonEl, option) {
    const index = appState.challengeState.currentQuestionIndex;
    
    // Jangan proses jika sudah dijawab
    if (appState.challengeState.answerStatus[index] !== null) return; 

    // Hapus seleksi sebelumnya & feedback sebelumnya
    const optionsContainer = document.getElementById('challenge-options-container');
    optionsContainer.querySelectorAll('.option-button').forEach(btn => {
        btn.classList.remove('selected', 'feedback-correct', 'feedback-incorrect');
        btn.disabled = false; // Aktifkan kembali (meskipun akan dinonaktifkan lagi jika jawaban dievaluasi)
    });
    
    buttonEl.classList.add('selected'); // Tandai yang baru dipilih
    appState.challengeState.userAnswers[index] = option;

    // Cek jawaban
    const correctAnswer = appState.challengeState.questions[index].answer;
    const feedbackBox = document.getElementById('challenge-feedback-box');
    
    if (option === correctAnswer) {
        appState.challengeState.answerStatus[index] = 'correct';
        buttonEl.classList.add('feedback-correct');
        feedbackBox.textContent = 'Jawaban Benar!';
        feedbackBox.className = 'mt-4 text-center font-semibold text-green-600';
         // Disable semua opsi jika benar
        optionsContainer.querySelectorAll('.option-button').forEach(b => b.disabled = true);
    } else {
        appState.challengeState.answerStatus[index] = 'incorrect';
        buttonEl.classList.add('feedback-incorrect');
        feedbackBox.textContent = 'Jawaban Kurang Tepat.';
        feedbackBox.className = 'mt-4 text-center font-semibold text-red-600';
         // Disable semua opsi jika salah
        optionsContainer.querySelectorAll('.option-button').forEach(b => b.disabled = true);
    }
    
    saveState(); // Simpan status jawaban
    updateChallengeQuestionPanel(); // Update panel nomor soal
}

function showClue() {
    const index = appState.challengeState.currentQuestionIndex;
    if (!appState.challengeState.cluesUsed[index]) {
        const q = appState.challengeState.questions[index];
        const clueBox = document.getElementById('clue-box');
        clueBox.textContent = q.clue;
        clueBox.style.display = 'block';
        document.getElementById('clue-button').disabled = true;
        appState.challengeState.cluesUsed[index] = true;
        saveState();
    }
}

function updateChallengeQuestionPanel() {
    const panel = document.getElementById('challenge-question-panel');
    panel.innerHTML = '';
    for (let i = 0; i < 3; i++) { // Jumlah soal tantangan = 3
        const item = document.createElement('div');
        item.className = 'question-panel-item';
        item.textContent = i + 1;
        item.onclick = () => displayChallengeQuestion(i);
        
        if (i === appState.challengeState.currentQuestionIndex) {
            item.classList.add('current');
        } else if (appState.challengeState.answerStatus[i] === 'correct') {
            item.classList.add('answered'); // Hijau jika benar
        } else if (appState.challengeState.answerStatus[i] === 'incorrect') {
            item.classList.add('answered-incorrect'); // Merah jika salah
        }
        
        panel.appendChild(item);
    }
}

function updateChallengeNavButtons() {
    const prevBtn = document.getElementById('challenge-prev-button');
    const nextBtn = document.getElementById('challenge-next-button');
    prevBtn.disabled = appState.challengeState.currentQuestionIndex === 0;
    nextBtn.disabled = appState.challengeState.currentQuestionIndex === 2; // Indeks terakhir = 2
    prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
    nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
}

function handleChallengeNav(direction) {
    let newIndex = appState.challengeState.currentQuestionIndex + direction;
    if (newIndex >= 0 && newIndex < 3) displayChallengeQuestion(newIndex);
}

function startChallengeTimer() {
    if(challengeTimerInterval) clearInterval(challengeTimerInterval);
    challengeTimerInterval = setInterval(() => {
        if (!appState.challengeState) { // Tambahan: Cek jika state ada
             clearInterval(challengeTimerInterval);
             return;
        }
        appState.challengeState.remainingTime--;
        const mins = Math.floor(appState.challengeState.remainingTime / 60);
        const secs = appState.challengeState.remainingTime % 60;
        document.getElementById('challenge-timer').textContent = `Waktu: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        if (appState.challengeState.remainingTime <= 0) finishChallenge();
    }, 1000);
}

function confirmFinishChallenge() {
     // Cek apakah semua soal sudah dijawab (walaupun ada feedback langsung)
    const allAnswered = appState.challengeState.answerStatus.every(status => status !== null);
    const message = allAnswered ? 'Yakin ingin menyelesaikan tantangan?' : 'Masih ada soal yang belum dicoba jawab. Yakin ingin menyelesaikan tantangan?';
    document.getElementById('confirm-submit-message').textContent = message;
    document.getElementById('confirm-submit-yes-button').onclick = finishChallenge;
    showModal('confirm-submit-modal');
}

function finishChallenge() {
    closeModal('confirm-submit-modal');
    clearInterval(challengeTimerInterval);
    showPage('challenge-report-page');
    generateChallengeReport();
}

// --- LOGIKA LAPORAN TANTANGAN ---
function generateChallengeReport() {
    document.getElementById('challenge-result-name').textContent = appState.studentName;
    document.getElementById('challenge-result-class').textContent = appState.studentClass;

    let totalScore = 0;
    const summaryContainer = document.getElementById('challenge-summary-container');
    summaryContainer.innerHTML = ''; 

    appState.challengeState.questions.forEach((q, i) => {
        let score = 0;
        let statusText = "Belum Dijawab";
        let cardClass = 'bg-slate-50 border-slate-300';

        if (appState.challengeState.answerStatus[i] === 'correct') {
            score = q.points;
            totalScore += score;
            statusText = `Benar (+${score} poin)`;
             cardClass = 'bg-green-50 border-green-300';
        } else if (appState.challengeState.answerStatus[i] === 'incorrect') {
            statusText = "Salah (0 poin)";
             cardClass = 'bg-red-50 border-red-300';
        }
        
        summaryContainer.innerHTML += `
             <div class="p-4 rounded-lg border ${cardClass}">
                 <p class="font-bold mb-1">Soal ${i + 1}</p>
                 <p class="text-sm text-slate-600 mb-2">${q.question}</p>
                 <p class="text-sm font-semibold">Status: ${statusText}</p>
                 <p class="text-sm mt-1">Jawaban Anda: <span class="font-semibold">${appState.challengeState.userAnswers[i] || '-'}</span></p>
                 ${appState.challengeState.answerStatus[i] !== 'correct' ? `<p class="text-sm text-green-700">Jawaban Benar: <span class="font-semibold">${q.answer}</span></p>` : '' }
            </div>
        `;
    });

    document.getElementById('challenge-total-score').textContent = totalScore;
    
     if (window.MathJax) {
        MathJax.typesetPromise([summaryContainer]);
    }
}

// --- LOGIKA UJIAN TURUNAN (BARU) ---
let finalExamTimerInterval;

function startFinalExam() {
    closeModal('confirm-final-exam-modal'); 

    // Ambil soal ujian
    const finalExamQuestions = [];
    Object.keys(finalExamBank).forEach(topicId => {
        finalExamQuestions.push(...shuffleAndPick(finalExamBank[topicId], 4)); // 4 soal x 5 materi = 20 soal
    });
     // Acak urutan 20 soal gabungan
    const shuffledFinalQuestions = shuffleAndPick(finalExamQuestions, 20);


    appState.finalExamState = {
        questions: shuffledFinalQuestions,
        userAnswers: Array(20).fill(null),
        currentQuestionIndex: 0,
        remainingTime: 40 * 60 // 40 Menit
    };
    
    showPage('final-exam-page');
    displayFinalExamQuestion(0);
    startFinalExamTimer();
}

function displayFinalExamQuestion(index) {
    appState.finalExamState.currentQuestionIndex = index;
    const q = appState.finalExamState.questions[index];
    document.getElementById('final-exam-current-question-number').textContent = index + 1;
    document.getElementById('final-exam-question-text').textContent = q.question;
    
    const optionsContainer = document.getElementById('final-exam-options-container');
    optionsContainer.innerHTML = '';
    const optionLetters = ['A', 'B', 'C', 'D'];
    q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'option-button p-4 border-2 rounded-lg flex items-center gap-4 text-left';
        btn.innerHTML = `<span class="font-bold">${optionLetters[i]}.</span><span>${opt}</span>`;
        btn.onclick = () => selectFinalExamOption(opt);
        if (appState.finalExamState.userAnswers[index] === opt) btn.classList.add('selected');
        optionsContainer.appendChild(btn);
    });
    
    updateFinalExamQuestionPanel();
    updateFinalExamNavButtons();
    if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('final-exam-question-area')]);
    }
}

function selectFinalExamOption(option) {
    const index = appState.finalExamState.currentQuestionIndex;
    appState.finalExamState.userAnswers[index] = option;
    displayFinalExamQuestion(index);
}

function updateFinalExamQuestionPanel() {
    const panel = document.getElementById('final-exam-question-panel');
    panel.innerHTML = '';
    for (let i = 0; i < 20; i++) { // 20 soal
        const item = document.createElement('div');
        item.className = 'question-panel-item';
        item.textContent = i + 1;
        item.onclick = () => displayFinalExamQuestion(i);
        if (i === appState.finalExamState.currentQuestionIndex) item.classList.add('current');
        else if (appState.finalExamState.userAnswers[i] !== null) item.classList.add('answered');
        panel.appendChild(item);
    }
}

function updateFinalExamNavButtons() {
    const prevBtn = document.getElementById('final-exam-prev-button');
    const nextBtn = document.getElementById('final-exam-next-button');
    prevBtn.disabled = appState.finalExamState.currentQuestionIndex === 0;
    nextBtn.disabled = appState.finalExamState.currentQuestionIndex === 19; // Indeks 0-19
    prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
    nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
}

function handleFinalExamNav(direction) {
    let newIndex = appState.finalExamState.currentQuestionIndex + direction;
    if (newIndex >= 0 && newIndex < 20) displayFinalExamQuestion(newIndex);
}

function startFinalExamTimer() {
    if(finalExamTimerInterval) clearInterval(finalExamTimerInterval);
    finalExamTimerInterval = setInterval(() => {
        if (!appState.finalExamState) {
             clearInterval(finalExamTimerInterval);
             return;
        }
        appState.finalExamState.remainingTime--;
        const mins = Math.floor(appState.finalExamState.remainingTime / 60);
        const secs = appState.finalExamState.remainingTime % 60;
        document.getElementById('final-exam-timer').textContent = `Waktu: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        if (appState.finalExamState.remainingTime <= 0) finishFinalExam();
    }, 1000);
}

function confirmFinishFinalExam() {
    const unanswered = appState.finalExamState.userAnswers.filter(a => a === null).length;
    const message = unanswered > 0 ? `Masih ada ${unanswered} soal belum dijawab. Yakin kumpulkan Ujian?` : 'Yakin ingin mengumpulkan Ujian?';
    document.getElementById('confirm-submit-message').textContent = message;
    document.getElementById('confirm-submit-yes-button').onclick = finishFinalExam;
    showModal('confirm-submit-modal');
}

function finishFinalExam() {
    closeModal('confirm-submit-modal');
    clearInterval(finalExamTimerInterval);
    appState.finalExamCompleted = true; // KUNCI: Tandai ujian sudah selesai
    saveState(); // Simpan status selesai
    showPage('final-exam-report-page');
    generateFinalExamReport();
}

// --- LOGIKA LAPORAN UJIAN TURUNAN ---
function generateFinalExamReport() {
    document.getElementById('final-exam-result-name').textContent = appState.studentName;
    document.getElementById('final-exam-result-class').textContent = appState.studentClass;

    let correctAnswers = 0;
    appState.finalExamState.questions.forEach((q, i) => {
        if (q.answer === appState.finalExamState.userAnswers[i]) correctAnswers++;
    });

    const totalScore = correctAnswers * 5; // 20 soal, 5 poin/soal
    document.getElementById('final-exam-final-score').textContent = totalScore;
    
    let message = totalScore >= 70 ? "Luar Biasa! Pemahamanmu sangat matang!" : "Cukup baik, tapi perlu sedikit review lagi.";
    document.getElementById('final-exam-result-message').textContent = message;
    
    renderFinalExamReportDetails();
}

function renderFinalExamReportDetails() {
    const container = document.getElementById('final-exam-summary-container');
    container.innerHTML = '';
    appState.finalExamState.questions.forEach((q, i) => {
        const userAnswer = appState.finalExamState.userAnswers[i];
        const isCorrect = q.answer === userAnswer;
        const cardClass = isCorrect ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300';
        
        container.innerHTML += `
            <div class="p-4 rounded-lg border ${cardClass}">
                <p class="font-bold mb-2">Soal ${i + 1}</p>
                <div class="text-sm mb-2">${q.question}</div>
                <p class="text-sm mt-4">Jawaban Anda: <span class="font-semibold">${userAnswer || 'Tidak dijawab'}</span></p>
                ${!isCorrect ? `<p class="text-sm text-green-700">Jawaban Benar: <span class="font-semibold">${q.answer}</span></p>` : ''}
            </div>
        `;
    });
    if (window.MathJax) {
        MathJax.typesetPromise([container]);
    }
}


// --- EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    if(appState.studentName) {
        document.getElementById('student-name').value = appState.studentName;
        document.getElementById('student-class').value = appState.studentClass;
        showPage('main-menu-page');
    } else {
        showPage('login-page');
    }

    // Event listener untuk tombol navigasi Kuis
    document.getElementById('quiz-prev-button').addEventListener('click', () => handleQuizNav(-1));
    document.getElementById('quiz-next-button').addEventListener('click', () => handleQuizNav(1));

     // Event listener untuk tombol navigasi Latihan Ujian
    document.getElementById('exam-prev-button').addEventListener('click', () => handleExamNav(-1));
    document.getElementById('exam-next-button').addEventListener('click', () => handleExamNav(1));

    // Event listener untuk tombol navigasi Tantangan
    document.getElementById('challenge-prev-button').addEventListener('click', () => handleChallengeNav(-1));
    document.getElementById('challenge-next-button').addEventListener('click', () => handleChallengeNav(1));

    // Event listener untuk tombol navigasi Ujian Turunan (BARU)
    document.getElementById('final-exam-prev-button').addEventListener('click', () => handleFinalExamNav(-1));
    document.getElementById('final-exam-next-button').addEventListener('click', () => handleFinalExamNav(1));
});
</script>

</body>
</html>

